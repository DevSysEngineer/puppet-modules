#!/bin/sh
# Managed by puppet

die() {
    echo "$*" >&2
    exit 3
}

# Locate awk
AWK=$(command -v awk 2>/dev/null)
[ -n "$AWK" ] || die "akw not available"

# Locate cut
CUT=$(command -v cut 2>/dev/null)
[ -n "$CUT" ] || die "cut not available"

# Locate date
DATE=$(command -v date 2>/dev/null)
[ -n "$DATE" ] || die "date not available"

# Locate grep
GREP=$(command -v grep 2>/dev/null)
[ -n "$GREP" ] || die "grep not available"

# Locate printf
PRINTF=$(command -v printf 2>/dev/null)
[ -n "$PRINTF" ] || die "printf not available"

# Locate sed
SED=$(command -v sed 2>/dev/null)
[ -n "$SED" ] || die "sed not available"

<% if @systemd_enable -%>
# Locate systemctl
SYSTEMDCTL=$(command -v systemctl 2>/dev/null)
[ -n "$SYSTEMDCTL" ] || die "systemctl not available"

<% end -%>
# Locate tail
TAIL=$(command -v tail 2>/dev/null)
[ -n "$TAIL" ] || die "tail not available"

# Locate ps
PS=$(command -v ps 2>/dev/null)
[ -n "$PS" ] || die "ps not available"

# Locate wc
WC=$(command -v wc 2>/dev/null)
[ -n "$WC" ] || die "wc not available"

crit() {
    $PRINTF '%s\n' "$*" >&2
    exit 2
}

# Default values
CRIT_MSG=""
CRIT_NO_SCAN_DAYS=14  # CRITICAL if >14 days
CRIT_UPDATE_MIN=1440   # CRITICAL if >24h
ENGINE_VER=0
LAST_CLEAN=0
LAST_DET=0
LAST_FILES=0
LAST_SCAN_EPOCH=0
LAST_SCAN_AGE=9999
LAST_SCAN_SECS=0
LSLOG=/opt/eset/efs/bin/lslog
NOW_EPOCH=`$DATE +%s`
STATE_CODE=0
UPDATE_AGE_MIN=999999
UPD=/opt/eset/efs/bin/upd
WAP_FLAG=/opt/eset/efs/etc/WAP_DISABLED
WARN_MSG=""
WARN_NO_SCAN_DAYS=7   # WARNING if no on‑demand scan in >7 days
WARN_UPDATE_MIN=720   # WARNING if no engine update for >12h

# Options 
while getopts 'n:N:s:S:u:U:h' opt; do
  case "$opt" in
    n) WARN_NO_SCAN_DAYS="$OPTARG" ;;
    N) CRIT_NO_SCAN_DAYS="$OPTARG" ;;
    u) WARN_UPDATE_MIN="$OPTARG" ;;
    U) CRIT_UPDATE_MIN="$OPTARG" ;;
    *) die "Usage: $0 [-n <days>] [-N <days>] [-u <min>] [-U <min>]" ;;
  esac
done

add_crit() {
    CRIT_MSG="${CRIT_MSG:+$CRIT_MSG; }$1"
}

add_warn() {
    WARN_MSG="${WARN_MSG:+$WARN_MSG; }$1"
}

# Service running
<% if @systemd_enable -%>
$SYSTEMDCTL is-active --quiet "efs.service" || crit "ESET service is not active"
<% else -%>
$PS -C efs >/dev/null 2>&1 || crit "ESET service is not active"
<% end -%>

# Check essential ESET daemons
DAEMONS="oaeventd scand updated logd confd licensed utild sysinfod"
[ ! -f "$WAP_FLAG" ] && DAEMONS="$DAEMONS wapd"
for d in $DAEMONS; do
  $PS -e -o comm= | $GREP -qx "$d" || add_crit "$d down"
done

# Check kernel modules
$GREP -qw eset_rtp /proc/modules || add_crit "eset_rtp missing"
if [ ! -f "$WAP_FLAG" ]; then
  $GREP -qw eset_wap /proc/modules || add_crit "eset_wap missing"
fi

# Detection engine version & age
LINE=$($UPD -l 2>/dev/null | $GREP -m1 "Detection engine")
if [ -n "$LINE" ]; then
    ENGINE_VER=$($PRINTF '%s' "$LINE" | $AWK '{print $2}')
fi

# On‑demand scan stats
SCAN_CSV=$($LSLOG -s -c 2>/dev/null)
SCANS_TOTAL=$($PRINTF '%s' "$SCAN_CSV" | $TAIL -n +2 | $WC -l)
LAST_LINE=$($PRINTF '%s' "$SCAN_CSV" | $TAIL -n 1)
case "$LAST_LINE" in Time*|'') : ;;
    *)
        IFS=',' read STARTED _ LAST_FILES LAST_CLEAN LAST_DET DURATION _ <<EOF
$LAST_LINE
EOF
        LAST_SCAN_EPOCH=$($DATE -d "$STARTED" +%s 2>/dev/null)
        LAST_SCAN_AGE=$(((NOW_EPOCH - LAST_SCAN_EPOCH) / 86400))
        IFS=':' read H M S <<EOF
$DURATION
EOF
        LAST_SCAN_SECS=$((10#$H*3600 + 10#$M*60 + 10#$S))
    ;;
esac
[ "$LAST_SCAN_AGE" -ge "$CRIT_NO_SCAN_DAYS" ] && add_crit "no scan ${LAST_SCAN_AGE}d"
[ "$LAST_SCAN_AGE" -ge "$WARN_NO_SCAN_DAYS" ] && [ "$LAST_SCAN_AGE" -lt "$CRIT_NO_SCAN_DAYS" ] && add_warn "no scan ${LAST_SCAN_AGE}d"
[ "$LAST_DET" -gt 0 ] && add_crit "scan det=$LAST_DET"
[ "$LAST_CLEAN" -gt 0 ] && [ "$LAST_DET" -eq 0 ] && add_warn "scan cleaned=$LAST_CLEAN"

# Cumulative detections
DETECTIONS_TOTAL=$($LSLOG -d -c 2>/dev/null | $TAIL -n +2 | $WC -l | $AWK '{print $1}')

# Update gap
LAST_OK=$( $LSLOG -c 2>/dev/null | grep -F "Detection Engine was successfully updated" | $TAIL -n 1 )
[ -n "$LAST_OK" ] && UPDATE_AGE_MIN=$(( (NOW_EPOCH-$($DATE -d "$($PRINTF '%s' "$LAST_OK"| $CUT -d ',' -f1)" +%s))/60 ))
[ "$UPDATE_AGE_MIN" -ge "$CRIT_UPDATE_MIN" ] && add_crit "no upd $((UPDATE_AGE_MIN/60))h"
[ "$UPDATE_AGE_MIN" -ge "$WARN_UPDATE_MIN" ] && [ "$UPDATE_AGE_MIN" -lt "$CRIT_UPDATE_MIN" ] && add_warn "upd gap $((UPDATE_AGE_MIN/60))h"

# Update error
UPDATES_FAILED=$($LSLOG -c 2>/dev/null | $GREP -F "Cannot check new application update" | $AWK -F ',' '{print $1}' | while read TS; do [ $(( NOW_EPOCH - $($DATE -d "$TS" +%s 2>/dev/null) )) -le 3600 ] && printf x; done | $WC -l | $AWK '{print $1}')
[ "$UPDATES_FAILED" -gt 0 ] && add_warn "$UPDATES_FAILED update errors (1h)"
 
# Create message
if [ "$LAST_SCAN_EPOCH" -gt 0 ]; then
    LAST_SCAN_HUMAN=$($DATE -d "@$LAST_SCAN_EPOCH" '+%Y-%m-%d %H:%M')
    MSG="ESET engine version $ENGINE_VER (age ${UPDATE_AGE_MIN}m); Last scan ${LAST_SCAN_HUMAN}"
else
    MSG="ESET engine version $ENGINE_VER (age ${UPDATE_AGE_MIN}m)"
fi

# Final state
[ -n "$CRIT_MSG" ] && STATE_CODE=2;
[ -z "$CRIT_MSG" ] && [ -n "$WARN_MSG" ] && STATE_CODE=1;

# Create message
[ -n "$CRIT_MSG" ] && MSG="$MSG; Critical(s): $CRIT_MSG"
[ -n "$WARN_MSG" ] && MSG="$MSG; Warnin(s): $WARN_MSG"

# Create perf data
PERF="engine_version=${ENGINE_VER}"
PERF="$PERF update_age=${UPDATE_AGE_MIN}m;${WARN_UPDATE_MIN};${CRIT_UPDATE_MIN};0"
PERF="$PERF update_failed=${UPDATES_FAILED}"
PERF="$PERF detections=${DETECTIONS_TOTAL}"
PERF="$PERF scans_toal=${SCANS_TOTAL}"
PERF="$PERF last_scan_age_days=${LAST_SCAN_AGE};${WARN_NO_SCAN_DAYS};${CRIT_NO_SCAN_DAYS};0"
PERF="$PERF last_scan_cleaned=${LAST_CLEAN}"
PERF="$PERF last_scan_detections=${LAST_DET}"
PERF="$PERF last_scan_duration=${LAST_SCAN_SECS}s"
PERF="$PERF last_scan_files=${LAST_FILES}"

# Show output
printf '%s | %s\n' "$MSG" "$PERF"
exit $STATE_CODE